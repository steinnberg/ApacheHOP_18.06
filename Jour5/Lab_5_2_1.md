# Proprement dans Atlas UI â†’ Aggregations, Ã©tape par Ã©tape.

Faire :

1ï¸âƒ£ $set â†’ crÃ©er la nouvelle structure imbriquÃ©e
2ï¸âƒ£ $merge â†’ sauvegarder dans la collection
3ï¸âƒ£ $unset â†’ supprimer les anciens champs plats


ğŸ¯ âš ï¸ Important

Dans Atlas UI :

* Chaque Ã©tape = un stage

* Lâ€™ordre des stages est critique

* **$merge** doit Ãªtre le dernier stage

Donc :
```
$set
$unset
$merge
```

---

## ğŸš€ Ã‰TAPE PAR Ã‰TAPE
ğŸ”¹ 1ï¸âƒ£ Stage $set

Clique :  Add Stage â†’ $set

Colle :
```
{
  "trip": {
    "pickupDatetime": "$tpep_pickup_datetime",
    "dropoffDatetime": "$tpep_dropoff_datetime",
    "passengers": "$passenger_count",
    "rateCode": "$RatecodeID",
    "storeAndForward": "$store_and_fwd_flag"
  },
  "route": {
    "from": "$PULocationID",
    "to": "$DOLocationID",
    "distance": "$trip_distance"
  },
  "financial": {
    "fare": "$fare_amount",
    "extra": "$extra",
    "tax": "$mta_tax",
    "tip": "$tip_amount",
    "tolls": "$tolls_amount",
    "surcharge": "$improvement_surcharge",
    "congestion": "$congestion_surcharge",
    "total": "$total_amount"
  },
  "payment": {
    "type": "$payment_type"
  }
}
```


ğŸ”¹ 2ï¸âƒ£ Stage $unset

Clique Add Stage â†’ **$unset**

Colle :
```
[
  "VendorID",
  "tpep_pickup_datetime",
  "tpep_dropoff_datetime",
  "passenger_count",
  "RatecodeID",
  "store_and_fwd_flag",
  "PULocationID",
  "DOLocationID",
  "trip_distance",
  "fare_amount",
  "extra",
  "mta_tax",
  "tip_amount",
  "tolls_amount",
  "improvement_surcharge",
  "congestion_surcharge",
  "total_amount",
  "payment_type"
]
```

 * Ã‡a supprime les champs plats.

ğŸ”¹ 3ï¸âƒ£ Stage $merge (IMPORTANT : dernier stage)

Clique Add Stage â†’ $merge

Colle :
```
{
  "into": "trips",
  "whenMatched": "merge",
  "whenNotMatched": "discard"
}
```
ğŸ¯ Puis clique Run

---

### ğŸ” VÃ©rification

- Verification dans Documents

Voir un document comme :
```
{
  vendorId: 1,
  trip: { ... },
  route: { ... },
  financial: { ... },
  payment: { ... }
}
```

- Et PLUS de champs plats.

---
### ğŸ§  Pourquoi $unset AVANT $merge ?
Parce que :

**$merge** Ã©crit le rÃ©sultat final

1. Tout ce qui est avant transforme le document en mÃ©moire

2. **$merge** commit les changements

3. Si  **$unset** aprÃ¨s **$merge**, Ã§a ne fonctionne pas.

## ğŸ“ Structure correcte dâ€™une pipeline de transformation
$set      â†’ enrichir
$unset    â†’ nettoyer
$merge    â†’ sauvegarder